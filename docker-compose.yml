# CyxCloud Docker Compose - Full Stack Testing
# Includes: PostgreSQL, Redis, CyxWiz API, Gateway (with embedded rebalancer), 3 Storage Nodes

services:
  # ===========================================
  # CyxWiz API - Authentication & Machine Registry
  # ===========================================
  cyxwiz-api:
    build:
      context: D:/Dev/cyxwiz_web/apps/api
      dockerfile: Dockerfile
    container_name: cyxcloud-cyxwiz-api
    ports:
      - "3002:3002"
    environment:
      RUST_LOG: info,cyxwiz_api=debug
      PORT: 3002
      MONGODB_URI: mongodb+srv://mrcj:joel2012@cyxwiz-cluster.auuzk3a.mongodb.net/cyxwiz
      JWT_SECRET: cyxcloud-dev-secret-change-in-production
      CENTRAL_SERVER_URL: http://gateway:50052
    networks:
      - cyxcloud-net
    # No healthcheck - curl not available in slim image
    restart: unless-stopped

  # ===========================================
  # PostgreSQL - Metadata storage
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: cyxcloud-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: cyxcloud
      POSTGRES_PASSWORD: cyxcloud_secret
      POSTGRES_DB: cyxcloud
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./cyxcloud-metadata/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - cyxcloud-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cyxcloud"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # ===========================================
  # Redis - Caching layer
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: cyxcloud-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - cyxcloud-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  # ===========================================
  # Gateway - S3-compatible API + gRPC
  # ===========================================
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway.build
    container_name: cyxcloud-gateway
    ports:
      - "8080:8080"     # HTTP/S3 API
      - "50052:50052"   # gRPC for nodes
    environment:
      RUST_LOG: info,cyxcloud_gateway=debug
      DATABASE_URL: postgres://cyxcloud:cyxcloud_secret@postgres:5432/cyxcloud
      REDIS_URL: redis://redis:6379
      JWT_SECRET: cyxcloud-dev-secret-change-in-production
      # Blockchain (optional - devnet)
      SOLANA_RPC_URL: https://api.devnet.solana.com
    command: ["--http-addr", "0.0.0.0:8080", "--grpc-addr", "0.0.0.0:50052", "--cors-permissive"]
    volumes:
      - gateway-data:/data
    networks:
      - cyxcloud-net
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # ===========================================
  # Storage Node 1
  # ===========================================
  node1:
    build:
      context: .
      dockerfile: Dockerfile.node
    container_name: cyxcloud-node1
    ports:
      - "50061:50051"   # gRPC
      - "4001:4001"     # libp2p
      - "9091:9090"     # Metrics
    environment:
      RUST_LOG: info,cyxcloud_node=debug
      NODE_ID: node-1
      NODE_NAME: storage-node-1
      PUBLIC_ADDRESS: node1
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: 50051
      LIBP2P_PORT: 4001
      METRICS_PORT: 9090
      STORAGE_PATH: /data/storage
      STORAGE_CAPACITY_GB: 100
      CENTRAL_SERVER_ADDR: http://gateway:50052
      BOOTSTRAP_PEERS: ""
      # CyxWiz API for authentication
      CYXWIZ_API_URL: http://cyxwiz-api:3002
      CYXWIZ_EMAIL: test@example.com
      CYXWIZ_PASSWORD: Test123!
    volumes:
      - node1-data:/data
    networks:
      - cyxcloud-net
    depends_on:
      gateway:
        condition: service_healthy
      cyxwiz-api:
        condition: service_started
    restart: unless-stopped

  # ===========================================
  # Storage Node 2
  # ===========================================
  node2:
    image: cyx_cloud-node1:latest
    container_name: cyxcloud-node2
    ports:
      - "50062:50051"
      - "4002:4001"
      - "9092:9090"
    environment:
      RUST_LOG: info,cyxcloud_node=debug
      NODE_ID: node-2
      NODE_NAME: storage-node-2
      PUBLIC_ADDRESS: node2
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: 50051
      LIBP2P_PORT: 4001
      METRICS_PORT: 9090
      STORAGE_PATH: /data/storage
      STORAGE_CAPACITY_GB: 100
      CENTRAL_SERVER_ADDR: http://gateway:50052
      BOOTSTRAP_PEERS: /dns4/node1/tcp/4001
      # CyxWiz API for authentication
      CYXWIZ_API_URL: http://cyxwiz-api:3002
      CYXWIZ_EMAIL: test@example.com
      CYXWIZ_PASSWORD: Test123!
    volumes:
      - node2-data:/data
    networks:
      - cyxcloud-net
    depends_on:
      gateway:
        condition: service_healthy
      cyxwiz-api:
        condition: service_started
      node1:
        condition: service_started
    restart: unless-stopped

  # ===========================================
  # Storage Node 3
  # ===========================================
  node3:
    image: cyx_cloud-node1:latest
    container_name: cyxcloud-node3
    ports:
      - "50063:50051"
      - "4003:4001"
      - "9093:9090"
    environment:
      RUST_LOG: info,cyxcloud_node=debug
      NODE_ID: node-3
      NODE_NAME: storage-node-3
      PUBLIC_ADDRESS: node3
      GRPC_HOST: 0.0.0.0
      GRPC_PORT: 50051
      LIBP2P_PORT: 4001
      METRICS_PORT: 9090
      STORAGE_PATH: /data/storage
      STORAGE_CAPACITY_GB: 100
      CENTRAL_SERVER_ADDR: http://gateway:50052
      BOOTSTRAP_PEERS: /dns4/node1/tcp/4001,/dns4/node2/tcp/4001
      # CyxWiz API for authentication
      CYXWIZ_API_URL: http://cyxwiz-api:3002
      CYXWIZ_EMAIL: test@example.com
      CYXWIZ_PASSWORD: Test123!
    volumes:
      - node3-data:/data
    networks:
      - cyxcloud-net
    depends_on:
      gateway:
        condition: service_healthy
      cyxwiz-api:
        condition: service_started
      node1:
        condition: service_started
      node2:
        condition: service_started
    restart: unless-stopped

# ===========================================
# Networks
# ===========================================
networks:
  cyxcloud-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ===========================================
# Volumes
# ===========================================
volumes:
  gateway-data:
  node1-data:
  node2-data:
  node3-data:
  postgres-data:
  redis-data:
